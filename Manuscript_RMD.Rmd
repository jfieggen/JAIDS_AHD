---
title: "AHD Manuscript (test)"
author: "Joshua Fieggen"
date: "28/03/2025"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Link to cohort

```{r, warning = FALSE, message= FALSE}
library(readxl)
library(tidyverse)
library(magrittr)
library(ggpubr)
library(cowplot)
library(ggsci)
library(lubridate)
library(zoo)
library(formattable)
library(caret)
library(plotROC)
library(dplyr)
library(ggplot2)
library(shiny)
library(readr)
library(eeptools)
library(survival)
library(survminer)
library(EpiStats)
library(tableone)
library(gtsummary)
setwd("/Volumes/Extreme SSD/Survival final")
Cohort <- read_csv("Cohort_Final_test.csv")
```

## Summary of the cohort and exploring data 

```{r pressure, echo=FALSE}
summary(Cohort)
```

## make changes to data structure and lables

```{r, warning = FALSE, message= FALSE}
#Changes to Data
Cohort$Enumeration_CD4 <- as.numeric(Cohort$Enumeration_CD4)

Data <- select(Cohort, study_id, Censored, Time, Enumeration_CD4, VL_E_Cat,VL_E_Not_Done, E_CD4_Cat, Hospital_Enumerations,
               Incident_Crypto, Prevalent_Crypto, Previous_Crypto,
               ART_Exp_C, Subs_Initiated, Time_To_First_ART, Reinitiated, Time_Reinitiation
               , Sex_B, Age, Age_Cat, Linked, Current_Diabetes, Current_Hypertension,    
               Current_CKD, Current_TB_PHDC, Previous_TB_PHDC, Incident_TB_PHDC)

Data <- within(Data, {
  `Viral Load at Enumeration` <- factor(VL_E_Cat, labels = c("< 100", "100 -1000", "> 1000"))
  `Enumeration VL Not Done` <- VL_E_Not_Done
ART <- factor(ART_Exp_C, levels = c("On ART","LTFU","Naive"), labels = c("On ART","LTFU","ART Naive"))  
  LTFU <- factor(Reinitiated, labels = c("Never Re-initiated", "Re-initiated"))
  `ART Naive` <- factor(Subs_Initiated, labels = c("Never Initiaited", "Subsequently Initiated"))
  `Enumeration CD4` <- Enumeration_CD4
  `Enumeration CD4 Categorical` <- factor(E_CD4_Cat, labels = c("101 - 199", "51 - 100", "0 - 50"))
  `Time in Cohort` <- Time
  `Time to Initiation` <- Time_To_First_ART
  `Time to Re-initiation` <- Time_Reinitiation
  Mortality <- factor(Censored, labels = c("Survived", "Died"))
  Sex <- factor(Sex_B, labels = c("Female", "Male"))
  `Sex (Male)` <- Sex_B
  `Age > 40` <- Age_Cat
  `Age` <- Age
  `Incident Cryptococcosis` <- Incident_Crypto
  `Current Cryptococcosis` <- Prevalent_Crypto
  `Previous Cryptococcosis` <- Previous_Crypto
  `Enumerated in Hospital` <- Hospital_Enumerations
  `NPR Linkage` <- factor(Linked, labels = c("Unlinked", "Linked"))
  `Diabetic` <- Current_Diabetes
  `Hypertension` <- Current_Hypertension
  `Chronic Kidney Disease` <- Current_CKD
  `Current TB (PHDC)` <- Current_TB_PHDC
  `Previous TB (PHDC)` <- Previous_TB_PHDC
  `Incident TB (PHDC)` <- Incident_TB_PHDC})

Data <- select(Data, study_id, `Time`, `Viral Load at Enumeration`, `Enumeration VL Not Done`, 
               `Enumeration CD4`, `Enumerated in Hospital`, `Enumeration CD4 Categorical`,
               `NPR Linkage`, `Mortality`,
               `Sex`, `Sex (Male)`, `Age > 40`, `Age`, 
               `Incident TB (PHDC)`, `Previous TB (PHDC)`, `Current TB (PHDC)`,
               `Previous Cryptococcosis`, `Current Cryptococcosis`, `Incident Cryptococcosis`, 
               `Chronic Kidney Disease`, `Hypertension`, `Diabetic`, 
               `ART Naive`, `LTFU`, `ART`, 
               `Time to Initiation`, `Time to Re-initiation`, Censored, VL_E_Cat)

colnames(Data)

Data$AgeCat_4<-cut(Data$Age, c(0,25,35,45,100))
summary(Data$AgeCat_4)
Data$Age_Cat_4 <- NA
Data$Age_Cat_4[Data$AgeCat_4=="(0,25]"] <- 0
Data$Age_Cat_4[Data$AgeCat_4=="(25,35]"] <- 1
Data$Age_Cat_4[Data$AgeCat_4=="(35,45]"] <- 2
Data$Age_Cat_4[Data$AgeCat_4=="(45,100]"] <- 3
table(Data$Age_Cat_4)
names(Data)[30] <- "Age_cat"
Data <- within(Data, {Age_cat <- factor(Age_cat, labels = c("18-25", "25-35", "35-45", ">45"))})
Data$Age_cat = relevel(Data$Age_cat, ref = "25-35")
summary(Data$Age_cat)

```

## Plot by mortality
```{r}
Mort_Plots <- subset(Cohort, Linked > 0)
Mort_Plots <- within(Mort_Plots, {  Mortality <- factor(Censored, labels = c("Survived", "Died"))})

ggdensity(Mort_Plots, x = "Enumeration_CD4",
          add = "median",
          color = "Mortality", fill = "Mortality",
          palette = c("#00AFBB", "#E7B800"))

ggdensity(Mort_Plots, x = "Time",
          add = "median",
          color = "Mortality", fill = "Mortality",
          palette = c("#00AFBB", "#E7B800"))

ggdensity(Mort_Plots, x = "Time_To_First_ART",
          add = "median",
          color = "Mortality", fill = "Mortality",
          palette = c("#00AFBB", "#E7B800"))

ggdensity(Mort_Plots, x = "Time_Reinitiation",
          add = "median",
          color = "Mortality", fill = "Mortality",
          palette = c("#00AFBB", "#E7B800"))

ggdensity(Mort_Plots, x = "Age",
          add = "median",
          color = "Mortality", fill = "Mortality",
          palette = c("#00AFBB", "#E7B800"))

```


## Plot by ART

```{r, echo = FALSE}

# Plot by ART
# Plot by ART
ggdensity(Cohort, x = "Enumeration_CD4",
          add = "median",
          color = "ART_Exp_C", fill = "ART_Exp_C",
          palette = c("#00AFBB", "#E7B800", "#FC4E07"))

ggdensity(Cohort, x = "Time",
          add = "median",
          color = "ART_Exp_C", fill = "ART_Exp_C",
          palette = c("#00AFBB", "#E7B800", "#FC4E07"))

ggdensity(Cohort, x = "Age",
          add = "median",
          color = "ART_Exp_C", fill = "ART_Exp_C",
          palette = c("#00AFBB", "#E7B800", "#FC4E07"))


```

## Create stratified summary tables 

```{r, warning = FALSE, message= FALSE}
## Table_1
library(tableone)
CreateTableOne(data = Data)

myVars <- c("Mortality", "NPR Linkage", "Sex", "Age > 40", "Age", "Enumeration CD4", "Enumeration CD4 Categorical",
            "Time in Cohort",
            "Viral Load at Enumeration", "Enumeration VL Not Done",  
            "ART", "ART Naive", "Time to Initiation", "LTFU", "Time to Re-initiation", 
            "Enumerated in Hospital",
            "Current TB (PHDC)", "Previous TB (PHDC)", "Incident TB (PHDC)",
            "Current Cryptococcosis", "Previous Cryptococcosis",  "Incident Cryptococcosis","Age_cat")

catVars <- c("Mortality", "NPR Linkage", "Sex", "Age > 40", "Enumeration CD4 Categorical",
             "Viral Load at Enumeration", "Enumeration VL Not Done",
             "Enumerated in Hospital", "Current TB (PHDC)", "Previous TB (PHDC)", "Incident TB (PHDC)",
             "ART", "ART Naive", "LTFU",
             "Previous Cryptococcosis", "Current Cryptococcosis", "Incident Cryptococcosis","Age_cat")

tab2 <- CreateTableOne(vars = myVars, data = Data, factorVars = catVars)
#Add non-normality
non_normal <- c("Age", "Time to Re-initiation", "Time to Initiation", "Time in Cohort", "Enumeration CD4")
print(tab2, nonnormal = non_normal, quote = TRUE, noSpaces = TRUE)

#Linked vs unlinked
tab_linked <- CreateTableOne(vars = myVars, strata = "NPR Linkage" , data = Data, factorVars = catVars)
print(tab_linked, nonnormal = non_normal, quote = TRUE, noSpaces = TRUE)

#Stratified (Mortality status)
Linked_Data <- subset(Data, `NPR Linkage` == "Linked")
tab3 <- CreateTableOne(vars = myVars, strata = "Mortality" , data = Linked_Data, factorVars = catVars)
print(tab3, nonnormal = non_normal, quote = TRUE, noSpaces = TRUE)


#Stratified table 2 (LTFU/Re-initiation status)
tab4 <- CreateTableOne(vars = myVars, strata = "LTFU" , data = Data, factorVars = catVars)
print(tab4, nonnormal = non_normal, quote = TRUE, noSpaces = TRUE)

#Stratified table 3 (ART Naive/initiation status)
tab5 <- CreateTableOne(vars = myVars, strata = "ART Naive" , data = Data, factorVars = catVars)
print(tab5, nonnormal = non_normal, quote = TRUE, noSpaces = TRUE)

#Stratified table 4 (ART)
tab6 <- CreateTableOne(vars = myVars, strata = "ART" , data = Data, factorVars = catVars)
print(tab6, nonnormal = non_normal, quote = TRUE, noSpaces = TRUE)

```


## Survival anaylsis

```{r, warning = FALSE, message= FALSE}
### Overall ART KM
ggsurvplot(
  fit = survfit(Surv(Time, Censored) ~ ART, data = Linked_Data), 
  risk.table = TRUE,
  cumevents = TRUE,
  conf.int = T,
  pval = TRUE,
  palette = "npg", 
  linetype = "solid",
  risk.table.height = 0.2,
  cumevents.height = 0.2,
  xlim = c(0,1000),
  xlab = "Days", 
  break.time.by = 90, 
  ylim = c(0, 1),
  ylab = "Survival",
  legend = "top",
  title = "Time to death among linked patients stratifed by ART exposure at enumeration")


### Zoomed in Overall ART KM
ggsurvplot(
  fit = survfit(Surv(Time, Censored) ~ ART, data = Linked_Data),
  legend = "none",
  risk.table = F,
  cumevents = F,
  conf.int = T,
  pval = F,
  palette = "npg", 
  linetype = "solid",
  xlim = c(0,1000),
  break.time.by = 180, 
  ylim = c(0.8, 1),
  xlab = "", 
  ylab = "")


### VL KM
### On ART by VL KM
L_Data <- subset(Data, `NPR linkage` = "Linked")
On_ART <- subset(L_Data, ART == "On ART")
On_ART$VL <- On_ART$`Viral Load at Enumeration`
summary(On_ART$VL)

ggsurvplot(
  fit = survfit(Surv(Time, Censored) ~ VL, data = On_ART), 
  risk.table = TRUE,
  cumevents = TRUE,
  conf.int = T,
  pval = TRUE,
  palette = "npg", 
  linetype = "solid",
  risk.table.height = 0.2,
  cumevents.height = 0.2,
  xlim = c(0,1000),
  xlab = "Days", 
  break.time.by = 90, 
  ylim = c(0, 1),
  ylab = "Survival",
  legend = "top",
  title = "Time to death among patients on ART at enumeration stratified by enumeration viral load")


# VL zoomed in 
ggsurvplot(
  fit = survfit(Surv(Time, Censored) ~ VL, data = On_ART),
  legend = "none",
  risk.table = F,
  cumevents = F,
  conf.int = T,
  pval = F,
  palette = "npg", 
  linetype = "solid",
  xlim = c(0,1000),
  break.time.by = 180, 
  ylim = c(0.8, 1),
  xlab = "", 
  ylab = "")

```

## Modelling

### Pre-process data again 

```{r, warning = FALSE, message= FALSE}
## Processing data
Cohort$VL_E_Cat[is.na(Cohort$VL_E_Cat)] = 3

Cohort$Enumeration_CD4 <- as.numeric(Cohort$Enumeration_CD4)

Data <- select(Cohort, study_id, Censored, Time, Enumeration_CD4, VL_E_Cat, E_CD4_Cat, Hospital_Enumerations,
               Incident_Crypto, Prevalent_Crypto, Previous_Crypto,
               ART_Exp_C, Subs_Initiated, Time_To_First_ART, Reinitiated, Time_Reinitiation
               , Sex_B, Age, Age_Cat, Linked, Current_Diabetes, Current_Hypertension,    
               Current_CKD, Current_TB_PHDC, Previous_TB_PHDC, Incident_TB_PHDC)
summary(Data)
table(Data$ART_Exp_C)
table(Data$Age_Cat)


Data <- within(Data, {
  `Viral Load at Enumeration` <- factor(VL_E_Cat, labels = c("< 100", "100 -1000", "> 1000", "None"))
  ART <- factor(ART_Exp_C, levels = c("On ART","LTFU","Naive"), labels = c("On ART","LTFU","ART Naive"))  
  Disengaged <- factor(Reinitiated, labels = c("Never Re-initiated", "Re-initiated"))
  `ART Naive` <- factor(Subs_Initiated, labels = c("Never Initiaited", "Subsequently Initiated"))
  `Enumeration CD4` <- Enumeration_CD4
  `Enumeration CD4 Categorical` <- factor(E_CD4_Cat, labels = c("101 - 199", "51 - 100", "0 - 50"))
  `Time in Cohort` <- Time
  `Time to Initiation` <- Time_To_First_ART
  `Time to Re-initiation` <- Time_Reinitiation
  Mortality <- factor(Censored, labels = c("Survived", "Died"))
  Sex <- factor(Sex_B, labels = c("Female", "Male"))
  `Sex (Male)` <- Sex_B
  `Age` <- Age
  `Incident Cryptococcosis` <- Incident_Crypto
  `Current Cryptococcosis` <- Prevalent_Crypto
  `Previous Cryptococcosis` <- Previous_Crypto
  `Enumerated in Hospital` <- Hospital_Enumerations
  `NPR Linkage` <- factor(Linked, labels = c("Unlinked", "Linked"))
  `Diabetic` <- Current_Diabetes
  `Hypertension` <- Current_Hypertension
  `Chronic Kidney Disease` <- Current_CKD
  `Current TB (PHDC)` <- Current_TB_PHDC
  `Previous TB (PHDC)` <- Previous_TB_PHDC
  `Incident TB (PHDC)` <- Incident_TB_PHDC
})

Data <- select(Data, study_id, `Time`, `Viral Load at Enumeration`, 
               `Enumeration CD4`, `Enumerated in Hospital`, `Enumeration CD4 Categorical`,
               `NPR Linkage`, `Mortality`,
               `Sex`, `Sex (Male)`, `Age`, 
               `Incident TB (PHDC)`, `Previous TB (PHDC)`, `Current TB (PHDC)`,
               `Previous Cryptococcosis`, `Current Cryptococcosis`, `Incident Cryptococcosis`, 
               `Chronic Kidney Disease`, `Hypertension`, `Diabetic`, 
               `ART Naive`, `Disengaged`, `ART`, 
               `Time to Initiation`, `Time to Re-initiation`, Censored, VL_E_Cat)


Linked_Data <- subset(Data, `NPR Linkage` == "Linked")

Linked_Data$AgeCat_4<-cut(Linked_Data$Age, c(0,25,35,45,100))
summary(Linked_Data$AgeCat_4)
Linked_Data$Age_Cat_4 <- NA
Linked_Data$Age_Cat_4[Linked_Data$AgeCat_4=="(0,25]"] <- 0
Linked_Data$Age_Cat_4[Linked_Data$AgeCat_4=="(25,35]"] <- 1
Linked_Data$Age_Cat_4[Linked_Data$AgeCat_4=="(35,45]"] <- 2
Linked_Data$Age_Cat_4[Linked_Data$AgeCat_4=="(45,100]"] <- 3
table(Linked_Data$Age_Cat_4)

Model_Data <- Linked_Data[, c("study_id", "Censored", "Time", "Age_Cat_4", "ART",
                              "Sex (Male)", "Enumeration CD4 Categorical","Previous TB (PHDC)",
                              "Incident TB (PHDC)" , "Current TB (PHDC)",
                              "Previous Cryptococcosis", "Viral Load at Enumeration", "Enumerated in Hospital")]

names(Model_Data)[4] <- "Age"
Model_Data <- within(Model_Data, {
  Age <- factor(Age, labels = c("18-25", "25-35", "35-45", ">45"))})
Model_Data$Age = relevel(Model_Data$Age, ref = "25-35")


Model_Data$Time <- Model_Data$Time + 0.5
names(Model_Data)[7] <- "CD4"
names(Model_Data)[8] <- "Previous TB"
names(Model_Data)[9] <- "Incident TB"
names(Model_Data)[10] <- "Current TB"


head(Model_Data)
```


### CPH Model 1
This model includes the variables:
ART
CD4 cat at enumeration
Sex
Age
Previous TB 
Previous Crypto

```{r, echo=FALSE}
surv_reg <- coxph(Surv(Time, Censored) ~ `ART` + `Sex (Male)` + Age + 
                     CD4 + `Previous TB` + `Previous Cryptococcosis`, data = Model_Data)
summary(surv_reg)
```

### It is important to note that the diagonstics of model 1 raise concerns about the PH assumption:
The statistically significant variables are age, CD4 count and ART status. A further analysis of these features is conducted after the uni-variate modelling. If one looks at the plots they highlight most of the hazzard diversion happen around the first +- year (with the worst in the first +- 90 days). Given p-values are not be the best way to evaluate the PH assumption given the large sample size the PH assumption has been evaluated for these features using KM plots, log-log curves and schoenfeld residuals. In this process it is noted that ART status is the most important violation of the PH assumption thus to better unpack this, stratifed models for each ART status are presented. 

## Stratifed CPH models for each ART category

```{r, warning = FALSE, message= FALSE}
On_ART <- subset(Model_Data, ART == "On ART")
Disengaged <- subset(Model_Data, ART == "LTFU")
Naive <- subset(Model_Data, ART == "ART Naive")

Surv_object_On_ART <- Surv(time = On_ART$Time, event = On_ART$Censored)
Surv_object_Disengaged <- Surv(time = Disengaged$Time, event = Disengaged$Censored)
Surv_object_Naive <- Surv(time = Naive$Time, event = Naive$Censored)

# Stratified Surv models
surv_ART1 <- coxph(Surv_object_On_ART ~ `Sex (Male)` + `Age` + `CD4` + 
                     `Previous TB` + `Previous Cryptococcosis`,data = On_ART)
summary(surv_ART1)

surv_ART2 <- coxph(Surv_object_On_ART ~ `Sex (Male)` + `Age` + `Viral Load at Enumeration` + 
                     `Previous TB` + `Previous Cryptococcosis`,data = On_ART)
summary(surv_ART2)

surv_Dis <- coxph(Surv_object_Disengaged ~ `Sex (Male)` + `Age` + `CD4` + 
                    `Previous TB` + `Previous Cryptococcosis`,data = Disengaged)
summary(surv_Dis)

surv_Naive <- coxph(Surv_object_Naive ~ `Sex (Male)` + `Age` + `CD4` + 
                      `Previous TB`,data = Naive)
summary(surv_Naive)
```

## Univariate modelling

```{r, warning = FALSE, message= FALSE}
## Univariate associations
univ_variables <- c("Age", "ART",
                    "Sex (Male)", "CD4","Previous TB",
                    "Incident TB" , "Current TB",
                    "Previous Cryptococcosis", "Viral Load at Enumeration", "Enumerated in Hospital")

univ_variables_strat <- c("Age", "Sex (Male)", "CD4","Previous TB",
                    "Incident TB" , "Current TB",
                    "Previous Cryptococcosis", "Viral Load at Enumeration", "Enumerated in Hospital")

univ_variables_strat2 <- c("Age", "Sex (Male)", "CD4","Previous TB",
                          "Incident TB" , "Current TB", "Enumerated in Hospital")

UV_all <- Model_Data %>% 
  dplyr::select(univ_variables, Censored) %>% # select variables to model
  tbl_uvregression(                         # produce univariate table
    method = glm,                           ## define regression 
    y = Censored,                            ## define outcome 
    method.args = list(family = binomial(log)),  ## define  type of glm 
    exponentiate = TRUE                     ## exponentiate to produce RR 
  )

UV_all <- UV_all %>%
  modify_table_body(
    ~ .x %>% select(-p.value)
  )

UV_ART <- On_ART %>% 
  dplyr::select(univ_variables_strat, Censored) %>% 
  tbl_uvregression(                         
    method = glm,                           
    y = Censored,                           
    method.args = list(family = binomial(log)),  
    exponentiate = TRUE                     
  )
UV_ART <- UV_ART %>%
  modify_table_body(
    ~ .x %>% select(-p.value)
  )



UV_Dis <- Disengaged %>% 
  dplyr::select(univ_variables_strat, Censored) %>% 
  tbl_uvregression(                         
    method = glm,                           
    y = Censored,                            
    method.args = list(family = binomial(log)),  
    exponentiate = TRUE                     
  )

UV_Dis <- UV_Dis %>%
  modify_table_body(
    ~ .x %>% select(-p.value)
  )


UV_Naive <- Naive %>% 
  dplyr::select(univ_variables_strat2, Censored) %>% 
  tbl_uvregression(                         
    method = glm,                           
    y = Censored,                            
    method.args = list(family = binomial(log)), 
    exponentiate = TRUE                     
    )
UV_Naive <- UV_Naive %>%
  modify_table_body(
    ~ .x %>% select(-p.value)
  )

```

### CPH univariate
```{r}
## Univariate associations using Cox models
library(survival)
library(dplyr)
library(gtsummary)

univ_variables <- c("Age", "ART", "Sex (Male)", "CD4", "Previous TB", "Incident TB", "Current TB", "Previous Cryptococcosis", "Viral Load at Enumeration", "Enumerated in Hospital")

univ_variables_strat <- c("Age", "Sex (Male)", "CD4", "Previous TB", "Incident TB", "Current TB", "Previous Cryptococcosis", "Viral Load at Enumeration", "Enumerated in Hospital")

univ_variables_strat2 <- c("Age", "Sex (Male)", "CD4", "Previous TB", "Incident TB", "Current TB", "Enumerated in Hospital")

# Create survival objects
Model_Data <- Model_Data #%>% mutate(Time = ..., Censored = ...) # Ensure Time and Censored columns are correctly set

Surv_object_Model_Data <- Surv(time = Model_Data$Time, event = Model_Data$Censored)

On_ART <- subset(Model_Data, ART == "On ART")
Disengaged <- subset(Model_Data, ART == "LTFU")
Naive <- subset(Model_Data, ART == "ART Naive")

Surv_object_On_ART <- Surv(time = On_ART$Time, event = On_ART$Censored)
Surv_object_Disengaged <- Surv(time = Disengaged$Time, event = Disengaged$Censored)
Surv_object_Naive <- Surv(time = Naive$Time, event = Naive$Censored)

# Univariate Cox models for all data
UV_all <- Model_Data %>% 
  dplyr::select(all_of(univ_variables), Time, Censored) %>% # select variables to model
  tbl_uvregression(                         # produce univariate table
    method = coxph,                         ## define regression 
    y = Surv(Time, Censored),               ## define outcome 
    exponentiate = TRUE                     ## exponentiate to produce HR 
  )

UV_all <- UV_all %>%
  modify_table_body(
    ~ .x %>% select(-p.value)
  )

# Univariate Cox models for On ART group
UV_ART <- On_ART %>% 
  dplyr::select(all_of(univ_variables_strat), Time, Censored) %>% 
  tbl_uvregression(                         
    method = coxph,                           
    y = Surv(Time, Censored),                           
    exponentiate = TRUE                     
  )

UV_ART <- UV_ART %>%
  modify_table_body(
    ~ .x %>% select(-p.value)
  )

# Univariate Cox models for Disengaged group
UV_Dis <- Disengaged %>% 
  dplyr::select(all_of(univ_variables_strat), Time, Censored) %>% 
  tbl_uvregression(                         
    method = coxph,                           
    y = Surv(Time, Censored),                            
    exponentiate = TRUE                     
  )

UV_Dis <- UV_Dis %>%
  modify_table_body(
    ~ .x %>% select(-p.value)
  )

# Univariate Cox models for Naive group
UV_Naive <- Naive %>% 
  dplyr::select(all_of(univ_variables_strat2), Time, Censored) %>% 
  tbl_uvregression(                         
    method = coxph,                           
    y = Surv(Time, Censored),                            
    exponentiate = TRUE                     
  )

UV_Naive <- UV_Naive %>%
  modify_table_body(
    ~ .x %>% select(-p.value)
  )

# Display tables
UV_all
UV_ART
UV_Dis
UV_Naive

```


### Combining all models into one single table
```{r, warning = FALSE, message= FALSE}

MV_1 <- tbl_regression(surv_reg, exponentiate = TRUE,pvalue_fun = ~style_pvalue(.x, digits = 2),) %>% 
  bold_labels()
MV_1 <- MV_1 %>%
  modify_table_body(
    ~ .x %>% select(-p.value)
  )


MV_2 <- tbl_regression(surv_ART1, exponentiate = TRUE,pvalue_fun = ~style_pvalue(.x, digits = 2),) %>% 
  bold_labels()
MV_2 <- MV_2 %>%
  modify_table_body(
    ~ .x %>% select(-p.value)
  )

MV_3 <- tbl_regression(surv_ART2, exponentiate = TRUE,pvalue_fun = ~style_pvalue(.x, digits = 2),) %>% 
  bold_labels()
MV_3 <- MV_3 %>%
  modify_table_body(
    ~ .x %>% select(-p.value)
  )

MV_4 <- tbl_regression(surv_Dis, exponentiate = TRUE,pvalue_fun = ~style_pvalue(.x, digits = 2),) %>% 
  bold_labels()
MV_4 <- MV_4 %>%
  modify_table_body(
    ~ .x %>% select(-p.value)
  )

MV_5 <- tbl_regression(surv_Naive, exponentiate = TRUE,pvalue_fun = ~style_pvalue(.x, digits = 2),) %>% 
  bold_labels()
MV_5 <- MV_5 %>%
  modify_table_body(
    ~ .x %>% select(-p.value)
  )
theme_gtsummary_compact()
tbl_merge(
  tbls = list(UV_all, MV_1, UV_ART, MV_2, MV_3, UV_Dis, MV_4, UV_Naive, MV_5),   # combine
  tab_spanner = c("**Univariable**",
                  "**Overall**",
                  "**Univariable**",
                  "**On ART 1**", 
                  "**On ART 2**",
                  "**Univariable**",
                  "**Disengaged**", 
                  "**Univariable**",
                  "**ART Naive**"))
```


## Diagnostics and alterantive considerations for overall CPH model
### Diagnostics 
```{r, echo=FALSE}
zp <- cox.zph(surv_reg)
print(zp)
ggcoxdiagnostics(surv_reg, type = "schoenfeld")
```

#### Age

KM Curves and log-log curves
```{r, echo=FALSE}
km_age <- survfit(Surv(Time, Censored) ~ Age, data = Model_Data)

ggsurvplot(
  fit = km_age, 
  break.time.by = 90,
  conf.int = TRUE,
  pval = TRUE,
  ylim = c(0.8, 1),
  legend = "right",
  xlab = "Days", 
  ylab = "Survival",
  title = "KM for age cats")

plot(km_age, fun = "cloglog", xlab = "Time (in days) using log",
     ylab = "log-log survival", main = "log-log curves by age") 


```

Schoenfield residuals
```{r, echo=FALSE}
plot(zp[3])
ggcoxzph(zp[3])
```

##### Summary of Age:
The age groups of 18-25 and 25-35 are clearly statstically significant as they cross. However, they seem so co-linear that it look like their hazard curves are almost the same in which case the crossing may not be a major issue.

#### CD4 count

KM Curves and log-log curves
```{r, echo=FALSE}
km_CD4 <- survfit(Surv(Time, Censored) ~ CD4, data = Model_Data)

ggsurvplot(
  fit = km_CD4, 
  break.time.by = 90,
  conf.int = TRUE,
  pval = TRUE,
  ylim = c(0.8, 1),
  legend = "right",
  xlab = "Days", 
  ylab = "Survival",
  title = "KM for CD4 cats")

plot(km_CD4, fun = "cloglog", xlab = "Time (in days) using log",
     ylab = "log-log survival", main = "log-log curves by CD4") 

```

Schoenfield residuals
```{r, echo=FALSE}
plot(zp[4])
ggcoxzph(zp[4])
```

##### Summary of CD4 
CD4 doesn't appear to violate the PH assumption signficiantly. Likely statistically significant because of the very beginning and end.

#### ART

KM Curves and log-log curves
```{r, echo=FALSE}
km_ART <- survfit(Surv(Time, Censored) ~ ART, data = Model_Data)

ggsurvplot(
  fit = km_ART, 
  break.time.by = 90,
  conf.int = TRUE,
  pval = TRUE,
  ylim = c(0.8, 1),
  legend = "right",
  xlab = "Days", 
  ylab = "Survival",
  title = "KM for ART cats")

plot(km_ART, fun = "cloglog", xlab = "Time (in days) using log",
     ylab = "log-log survival", main = "log-log curves by ART") 

```

Schoenfield residuals
```{r, echo=FALSE}
plot(zp[1])
ggcoxzph(zp[1])
```

##### Summary of ART
ART violates the PH assumption mostly in the early time period - this is best seen in the KM curves where the on ART group has an acute mortality risk that is much steeper than the other two groups. Various modelling strategies to overcome the violation of the PH assumption are subsequently evaluated. However, after evaluating all strategies and review with all authors it was concluded that ultimately the purpose of modelling in this study is not to get accurate estimates of mortality risk as the three ART groups reflect three different populations each confounded by important selection biases thus attempting to estimate accurate hazard/risk ratios over time would be attempting to approximate a false level of precision. Thus a decision was made to stick with CPH modelling while clearly understanding the limitations of it in this context. 

### Managing violations of the PH assumption
four approaches to managing the violation of the CPH assumption within ART were considered. 
1- stratifying by ART category (implemented in final modelling)
2- estimating a fully parametric model
3- emplyoing step functions
4- using time transformations
The most successful approaches were stratification and the use of an stpm2 model with 3 knots, 4 splines and a PH link function. 

However as discussed above it was ultimately decided to go with a CPH model as 1) the violation of the PH assumption is limited to the first time period for reasons discussed in the discussion and 2) the purpose of modelling in this study is hypothesis generating rather than attempting to accurately estimate risk magnitudes. 

#### Fitting stpm2 model
```{r}
library(rstpm2)
fit <- stpm2(Surv(Time, Censored) ~ ART, data = Model_Data, df=4)
eform(fit)[1:3,]

# Fit Cox proportional hazards model
cox.fit <- coxph(Surv(Time, Censored) ~ ART, data = Model_Data)

# Create survival curves (baseline survival function)
surv_curve <- survfit(cox.fit)

# Extract baseline hazard function
baseline_hazard <- -diff(surv_curve$surv) / diff(surv_curve$time)

# Plot the baseline hazard function
plot(surv_curve$time[-1], baseline_hazard, type = 'l',
     xlab = 'Time', ylab = 'Baseline Hazard',
     main = 'Baseline Hazard Function of Cox Model',
     ylim = c(0,0.005))

plot(fit, newdata=data.frame(ART = "On ART"),
     xlab="Time since enumeration (days)", main = "Univaraite flexible PH parametric model of ART plotted against KM")
lines(fit, newdata=data.frame(ART = "LTFU"), lty=2)
lines(fit, newdata=data.frame(ART = "ART Naive"), lty=3)
lines(survfit(Surv(Time, Censored)~ART, data=Model_Data), col="red", lty=1:3)
legend("topright", c("PH On ART","PH Disengaged","PH ART Naive",
                     "KM On ART","KM Disengaged","KM ART Naive"), 
       lty=1:3, col=c("black","black","black","red","red","red"))
```

#### Plotting hazard function
```{r}
predART <- predict(fit, newdata=data.frame(ART = c("On ART", "LTFU", "ART Naive")),
                   type = "hazard", grid=TRUE, full=TRUE, se.fit=TRUE)
#Transform
predART <- transform(predART,ART=factor(ART,labels=c("On ART","Disengaged", "Naive")))
#Plot
ggplot(predART, aes(x=Time, y=Estimate, ymin=lower, ymax=upper, fill = ART)) + 
  xlab("Time since enumeration") +
  ylab("Hazard") + 
  geom_ribbon() +
  geom_line()
```


## Additional stats and calculations

```{r}
# Evaluating re-initiating ART
Disengaged <- subset(Cohort, ART_Exp_C == "On ART")
table(Disengaged$Censored)
summary(Disengaged$Enumeration_CD4)
Disengaged_Time <- subset(Disengaged, Reinitiated == 1)
Disengaged_Time_0 <- subset(Disengaged_Time, Time_Reinitiation == 0)
Disengaged_14 <- subset(Disengaged, Time_Reinitiation < 15)
# Re-initiated in Hospital
table(Disengaged$Hospital_Enumerations)
Hospital_Disengaged <- subset(Disengaged, Hospital_Enumerations == 1)
Hospital_Disengaged <- subset(Hospital_Disengaged, Linked == 1)
Disengaged_H_60 <- subset(Hospital_Disengaged, Time_Reinitiation < 61)
Disengaged_H_D_60 <- subset(Hospital_Disengaged, Time_Reinitiation > 60 | Reinitiated == 0)
Disengaged_H_D_60_Less <- subset(Disengaged_H_D_60, Time < 61)
Disengaged_C <- subset(Disengaged_H_D_60, Time > 60)
table(Disengaged_C$Prevalent_Crypto)
table(Disengaged_C$Current_TB_PHDC)
Disengaged_C <- subset(Disengaged_C, Prevalent_Crypto == 0 & Current_TB_PHDC == 0)
table(Disengaged_C$Reinitiated)

#Re-initiated in PHC
table(Disengaged$Hospital_Enumerations)
PHC_Disengaged <- subset(Disengaged, Hospital_Enumerations == 0)
PHC_Disengaged <- subset(PHC_Disengaged, Linked == 1)
Disengaged_P_60 <- subset(PHC_Disengaged, Time_Reinitiation < 61)
Disengaged_P_D_60 <- subset(PHC_Disengaged, Time_Reinitiation > 60 | Reinitiated == 0)
Disengaged_P_D_60_Less <- subset(Disengaged_P_D_60, Time < 61)
Disengaged_P_C <- subset(Disengaged_P_D_60, Time > 60)
table(Disengaged_P_C$Prevalent_Crypto)
table(Disengaged_P_C$Current_TB_PHDC)
Disengaged_P_C <- subset(Disengaged_P_C, Prevalent_Crypto == 0 & Current_TB_PHDC == 0)
table(Disengaged_P_C$Reinitiated)


# Evaulating First Starting ART
Naive <- subset(Cohort, ART_Exp_C == "Naive")
table(Naive$Censored)
summary(Naive$Enumeration_CD4)
Naive_Time <- subset(Naive, Subs_Initiated == 1)
Naive_Time_0 <- subset(Naive_Time, Time_To_First_ART == 0)
Naive_14 <- subset(Naive, Time_To_First_ART < 15)
#First ART in Hospital
table(Naive$Hospital_Enumerations)
Hospital_Naive <- subset(Naive, Hospital_Enumerations == 1)
Hospital_Naive <- subset(Hospital_Naive, Linked == 1)
Naive_H_60 <- subset(Hospital_Naive, Time_To_First_ART < 61)
Naive_H_D_60 <- subset(Hospital_Naive, Time_To_First_ART > 60 | Subs_Initiated == 0)
Naive_H_D_60_Less <- subset(Naive_H_D_60, Time < 61)
Naive_C <- subset(Naive_H_D_60, Time > 60)
table(Naive_C$Prevalent_Crypto)
table(Naive_C$Current_TB_PHDC)
Naive_C <- subset(Naive_C, Prevalent_Crypto == 0 & Current_TB_PHDC == 0)
table(Naive_C$Subs_Initiated)

#First ART in PHC
table(Naive$Hospital_Enumerations)
PHC_Naive <- subset(Naive, Hospital_Enumerations == 0)
PHC_Naive <- subset(PHC_Naive, Linked == 1)
Naive_P_60 <- subset(PHC_Naive, Time_To_First_ART < 61)
Naive_P_D_60 <- subset(PHC_Naive, Time_To_First_ART > 60 | Subs_Initiated == 0)
Naive_P_D_60_Less <- subset(Naive_P_D_60, Time < 61)
Naive_P_C <- subset(Naive_P_D_60, Time > 60)
table(Naive_P_C$Prevalent_Crypto)
table(Naive_P_C$Current_TB_PHDC)
Naive_P_C <- subset(Naive_P_C, Prevalent_Crypto == 0 & Current_TB_PHDC == 0)
table(Naive_P_C$Subs_Initiated)

table(Disengaged_C$Reinitiated, Disengaged_C$Censored)
table(Disengaged_P_C$Reinitiated, Disengaged_P_C$Censored)
table(Naive_C$Subs_Initiated, Naive_C$Censored)
table(Naive_P_C$Subs_Initiated, Naive_P_C$Censored)


#One year mortality
Cohort_Linked <- subset(Cohort, Linked  == 1)
Cohort_Year <- subset(Cohort_Linked, Enumeration_date <= "2020-03-30")
Cohort_Died_More <- subset(Cohort_Year, Censored==1 & Time >365)
Cohort_Died_More$More_than_Year <- 1
Cohort_Year$More_than_Year <- 
  Cohort_Died_More$More_than_Year[match(Cohort_Year$study_id, Cohort_Died_More$study_id)]
Cohort_Year$More_than_Year[is.na(Cohort_Year$More_than_Year)] = 0
Cohort_Year <- subset(Cohort_Year, More_than_Year < 1)
table(Cohort_Year$Censored)
Cohort_Censored <- subset(Linked_Data, Mortality  == "Died")
plot(Cohort_Censored$Time)

Cen_Plot <- ggdensity(Cohort_Censored, x = "Time",
                        add = "median",
                        color = "ART", fill = "ART",
                        palette = "npg",
                      title = "Density plot of time to death by enumeration ART status")
Cen_Plot

Disengaged_60 <- subset(Disengaged, Time_Reinitiation < 61)
Naive_60 <- subset(Naive, Time_To_First_ART < 61)
```


